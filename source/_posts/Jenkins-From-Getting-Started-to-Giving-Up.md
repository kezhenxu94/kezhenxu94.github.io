---
title: Jenkins ä»å…¥é—¨åˆ°æ”¾å¼ƒ
tags:
  - Jenkins
  - Others
  - DevOps
date: 2018-05-20 15:33:59
updated: 2018-05-20 15:33:59
---



## Jenkins æ˜¯ä»€ä¹ˆ

Jenkins æ˜¯ä¸€ä¸ª**è‡ªåŠ¨åŒ–**æœåŠ¡å™¨, ä»–å¯ä»¥ç”¨æ¥å°†ä¸**æ„å»º**, **æµ‹è¯•**, **äº¤ä»˜**å’Œ**å‘å¸ƒ**ç­‰ç›¸å…³çš„å„ç§å„æ ·ä»»åŠ¡è‡ªåŠ¨åŒ–. 

æ ¹æ®ç»éªŒ, ä¸€é¡¹ä»»åŠ¡è¦æƒ³èƒ½å¤Ÿè‡ªåŠ¨åŒ–, å…¶æ“ä½œæ­¥éª¤åº”è¯¥æ˜¯ç›¸å¯¹å›ºå®šçš„, å¯é‡å¤çš„. ä¾‹å¦‚, å¦‚æœä½ æƒ³å¯¹ä»£ç è¿›è¡Œå•å…ƒæµ‹è¯•, å…¶æ­¥éª¤é€šå¸¸éƒ½æ˜¯æ›´æ–°æœ€æ–°ä»£ç , è¿è¡Œå•å…ƒæµ‹è¯•è„šæœ¬/å‘½ä»¤, å¯¹äºä½¿ç”¨ git ä½œä¸ºä»£ç ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ, maven ä½œä¸ºæ„å»ºå·¥å…·çš„é¡¹ç›®æ¥è¯´, æ­¥éª¤é€šå¸¸æ˜¯:

```shell
$ git pull
$ mvn test
```

å¯¹äºè¿è¡Œå•å…ƒæµ‹è¯•æ¥è¯´, ä»¥ä¸Šä¸¤ä¸ªå‘½ä»¤è¿˜ä¸è‡³äºå¯¼è‡´ Jenkins çš„å‘æ˜. ç”±äºè½¯ä»¶ç³»ç»Ÿå¼€å‘é˜¶æ®µçš„å‘¨æœŸä»ç¼–ç åˆ°äº¤ä»˜çš„æµç¨‹è¿œä¸æ­¢ä¸€ä¸¤ä¸ªå‘½ä»¤, å› æ­¤æ‰æœ‰äº† Jenkins. 

## Jenkins çš„ä¸€äº›æœ¯è¯­

å¦‚ä¸Šæ‰€è¿°, Jenkins æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æœåŠ¡å™¨, å¹¶ä¸”èƒ½å¤Ÿè¢«è‡ªåŠ¨åŒ–çš„ä»»åŠ¡å…¶æ­¥éª¤ç›¸å¯¹éƒ½æ¯”è¾ƒå›ºå®š, å› æ­¤ä¾¿å¯ä»¥å°†è‡ªåŠ¨åŒ–çš„æµç¨‹æŠ½è±¡ä¸ºä¸€ä¸ªç±»ä¼¼ç°å®ç”Ÿæ´»ä¸­**æµæ°´çº¿**çš„æ¦‚å¿µ, åœ¨ Jenkins ä¸­è¿™æ ·çš„æµæ°´çº¿è¢«ç§°ä¸º **Pipeline(ç®¡é“)**; æµæ°´çº¿ä¸Šæœ‰å¤šä¸ªæ“ä½œé˜¶æ®µ, è¿™äº›é˜¶æ®µä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰åºæ‰§è¡Œ, åœ¨ Jenkins è¿™äº›æ­¥éª¤è¢«ç§°ä¸º **Stage**; ä½œä¸ºä¸€ä¸ªé€šç”¨å·¥å…·, Jenkins æ— æ³•ä¿è¯æ‰€æœ‰é¡¹ç›®çš„æ¯ä¸ªé˜¶æ®µéƒ½åªæœ‰ä¸€ä¸ªä»»åŠ¡è¦åš, å› æ­¤å¯¹æ¯ä¸ª Stage åˆåˆ†ä¸ºå¤šä¸ªæ­¥éª¤, åœ¨ Jenkins ä¸­ç§°ä¸º **Step**, æ¯ä¸ªé˜¶æ®µåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Step. 

å¯ä»¥å°†ä¸€ä¸ªé¡¹ç›®çš„**å•å…ƒæµ‹è¯•**, **é›†æˆæµ‹è¯•**, **æ„å»º**, **éƒ¨ç½²**æ•´ä¸ªæµç¨‹å½“ä½œä¸€ä¸ª "Pipeline", å…¶ä¸­çš„**å•å…ƒæµ‹è¯•**, **é›†æˆæµ‹è¯•**ç­‰ç­‰éƒ½çœ‹ä½œä¸€ä¸ªä¸€ä¸ª "Stage", è€Œå•å…ƒæµ‹è¯•ä¸­, ç±»ä¼¼ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªå‘½ä»¤ `git pull` å’Œ `mvn test` å°±æ˜¯ Step.

## å…¥é—¨ç¤ºä¾‹

æœ¬æ–‡å°†ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ Spring MVC é¡¹ç›®, æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Jenkins æ„å»ºä½ çš„ç¬¬ä¸€ä¸ª Pipeline.

å¯¹äºæœ¬æ–‡ä¸­ä½¿ç”¨çš„ Spring MVC é¡¹ç›®, å¯ä»¥ç›´æ¥åœ¨[æ­¤å¤„](https://github.com/awesome-playground/jenkins-playground)è·å¾—.

ç¤ºä¾‹é¡¹ç›®æ‰€ä½¿ç”¨çš„ç¯å¢ƒ:

- æ“ä½œç³»ç»Ÿ: macOS High Sierra 10.13.4

- Jenkins: 2.122

- Docker: Version 18.03.1-ce-mac65 (24312)

### è·å– Jenkins

Jenkins å¯ä»¥é€šè¿‡ Docker å®‰è£…, åŒæ—¶, ç”±äº Jenkins æ˜¯è‡ªåŒ…å« (Self-Contained) çš„ (ä¸ä¾èµ–å…¶ä»–ä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿) ä¸€ä¸ªé¡¹ç›®, å› æ­¤ä½ ä¹Ÿå¯ä»¥ä¸‹è½½ Jenkins çš„ war åŒ…, åœ¨å®‰è£…äº† JRE çš„ç³»ç»Ÿä¸Šéƒ½å¯ä»¥å®Œç¾è¿è¡Œ. å¯ä»¥[åœ¨æ­¤å¤„ä¸‹è½½ Jenkins.war åŒ…](https://jenkins.io/download/), é€‰æ‹© "Generic Java package (.war)" å®Œæˆä¸‹è½½å³å¯.

### è¿è¡Œ Jenkins

ä¸‹è½½å®Œæˆå, åˆ‡æ¢åˆ° jenkins.war æ‰€åœ¨ç›®å½•, ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œ Jenkins:

```shell
$ java -jar jenkins.war --httpPort=8080
```

ç”±äº Jenkins æä¾›äº†ä¸€ä¸ª Web åº”ç”¨æ¥è®©æˆ‘ä»¬æ“ä½œ, å› æ­¤å…¶å¿…é¡»å ç”¨ä¸€ä¸ª http ç«¯å£, ä»¥ä¸Šçš„ `--httpPort=8080` æŒ‡å®šäº†è®©è¯¥ Web åº”ç”¨ç›‘å¬çš„ç«¯å£; Jenkins ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™éœ€è¦ä¸‹è½½ä¸€äº›å…ƒæ•°æ®, å› æ­¤å¿…é¡»ä¿è¯ä½ æœ‰ç¨³å®šçš„ç½‘ç»œè¿æ¥, å¦åˆ™å¯èƒ½å¯¼è‡´å¯åŠ¨å¤±è´¥æˆ–å¯åŠ¨åæ— æ³•æ­£å¸¸è¿è¡Œ.

å¾…å‘½ä»¤è¿è¡Œç¨³å®šå (è§†æœºå™¨æ€§èƒ½, å¯èƒ½éœ€è¦å‡ åç§’åˆ°å‡ åˆ†é’Ÿä¸ç­‰), å¦‚æœå‘½ä»¤è¡Œæ²¡æœ‰æŠ¥é”™, å°±å¯ä»¥æ‰“å¼€æµè§ˆå™¨å®šä½åˆ° http://127.0.0.1:8080 (å¦‚æœä½ æ”¹äº†ç«¯å£å·ï¼Œ è¯·å¯¹ URL åšç›¸åº”ä¿®æ”¹).

### åˆå§‹åŒ– Jenkins

ç¬¬ä¸€æ¬¡è¿è¡Œ Jenkins çš„æ—¶å€™, åœ¨å‘½ä»¤è¡Œä¸­å¯ä»¥çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡º, Jenkins ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªç®¡ç†å‘˜å¯†ç , åœ¨ç¬¬ä¸€æ¬¡ç™»é™† Jenkins Web åº”ç”¨çš„æ—¶å€™éœ€è¦ä½¿ç”¨è¯¥å¯†ç ç™»é™†;

```text
*************************************************************
*************************************************************
*************************************************************

Jenkins initial setup is required. An admin user has been created and a password generated.
Please use the following password to proceed to installation:

9fa5ba5b98c946ba9fe84a93e1987d8f

This may also be found at: /Users/kid/.jenkins/secrets/initialAdminPassword

*************************************************************
*************************************************************
*************************************************************
```

{% asset_img please-wait.png Jenkins åˆå§‹åŒ–ä¸­ %}

{% asset_img unlock-jenkins.png è§£é” Jenkins %}

è¾“å…¥ç®¡ç†å‘˜å¯†ç ä¹‹å Jenkins ä¼šæœ‰ä¸€ä¸ªåˆå§‹åŒ–çš„è¿‡ç¨‹.

### é€‰æ‹© Jenkins æ’ä»¶

Jenkins å¹¶ä¸è‡ªå·±å®Œæˆæµæ°´çº¿ä¸Šçš„æ‰€æœ‰æ“ä½œ, è€Œæ˜¯å°†å¾ˆå¤šæ“ä½œäº¤ç»™å…¶ä»–(æ›´æ“…é•¿çš„)å·¥å…·å®Œæˆ, Jenkins æœ¬èº«é€šè¿‡æ’ä»¶(Plugin)çš„å½¢å¼é›†æˆå®ƒä»¬, å› æ­¤æ­¤æ—¶ Jenkins ä¼šè®©ä½ é€‰æ‹©éœ€è¦ä½¿ç”¨çš„æ’ä»¶, å¥½åœ¨ Jenkins é»˜è®¤é€‰æ‹©çš„æ’ä»¶å·²ç»è¶³å¤Ÿæˆ‘ä»¬è¿™ä¸ªç¤ºä¾‹ä½¿ç”¨äº†, å› æ­¤æˆ‘ä»¬åªéœ€è¦é€‰æ‹© Jenkins ç»™æˆ‘ä»¬å»ºè®®çš„æ’ä»¶å°±å¥½äº†:

{% asset_img customize-jenkins.png è‡ªå®šä¹‰ Jenkins %}

æ¥ä¸‹æ¥ Jenkins ä¼šå®‰è£…ä¸€ç³»åˆ—æ’ä»¶, é™å€™å…¶å®Œæˆ.

### åˆ›å»ºç®¡ç†å‘˜è´¦å·

ç¬¬ä¸€æ¬¡è¿è¡Œ Jenkins æ—¶ç”Ÿæˆäº†ä¸€ä¸ªè¶…é•¿ç®¡ç†å‘˜è´¦å·, ä¸ºäº†é¿å…æ¯æ¬¡éƒ½è¾“å…¥è¿™ä¹ˆé•¿çš„å¯†ç å’Œå¯¹æƒé™è¿›è¡Œç»†åŒ–ç®¡ç†, æ­¤æ—¶è¿˜è¦åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦å·:

{% asset_img create-first-admin-user.png åˆ›å»ºç®¡ç†å‘˜è´¦å· %}

æŒ‰ç…§æç¤ºå¡«å†™å®Œæˆ, é€‰æ‹© "Continue as admin" è¿›å…¥ä¸‹ä¸€æ­¥.

{% asset_img instance-config.png é…ç½® URL %}

æ­¤æ—¶ä¼šè®©æˆ‘ä»¬å¡«å†™ä¸€ä¸ª URL åœ°å€, è¯¥ URL åœ°å€å°±æ˜¯ä¸“é—¨ç»™åˆšåˆšåˆ›å»ºçš„ç”¨æˆ·æ‰“å¼€çš„, è¿™æ ·å°±èƒ½è®©ä¸åŒçš„ç”¨æˆ·æœ‰ç›¸å¯¹ç‹¬ç«‹çš„æ“ä½œç©ºé—´, æ­¤æ—¶æˆ‘ä»¬æš‚æ—¶ä¸éœ€è¦è¿™æ ·çš„åŠŸèƒ½, é€‰æ‹© "Not now".

å®Œæˆ!!! é€‰æ‹© "Starting using Jenkins".

{% asset_img jenkins-is-ready.png Jenkins å‡†å¤‡å®Œæˆ %}

### åˆ›å»ºå·¥ä½œé¡¹

åœ¨ä¸»æ“ä½œç•Œé¢ä¸Šé€‰æ‹© "New Item" æ–°å»ºä¸€ä¸ªå·¥ä½œé¡¹, é€‰æ‹© "Multibranch Pipeline":

{% asset_img home-page.png Jenkins ä¸»ç•Œé¢ %}

{% asset_img enter-item-name.png è¾“å…¥é¡¹ç›®åç§° %}

### æ·»åŠ æºä»£ç 

é€‰æ‹© Branch Sources æ ‡ç­¾ä¸‹çš„ Add source, ç”±äºè¿™ä¸ªé¡¹ç›®æˆ‘ä»¬æ˜¯æ‰˜ç®¡åœ¨ GitHub ä¸Šçš„, è¿™é‡Œé€‰æ‹© GitHub, å…¶ä»–å¹³å°ç±»ä¼¼.

è¿™é‡Œæ¨èæˆ‘ä»¬æä¾›ä¸€ä¸ªå‡­è¯ Credential, ç”±äºè¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªå…¬å¼€çš„é¡¹ç›®, å³ä½¿æ²¡æœ‰ç™»é™†çš„ç”¨æˆ·ä¹Ÿå¯ä»¥è®¿é—®åˆ°, å› æ­¤æˆ‘ä»¬é€‰æ‹©ä¸æä¾›å‡­è¯, ç›´æ¥è¾“å…¥ Owner, Owner å¯ä»¥æ ¹æ® GitHub çš„åœ°å€å¾—åˆ°, ä¾‹å¦‚ GitHub åœ°å€æ˜¯ https://github.com/awesome-playground/jenkins-playground çš„é¡¹ç›®, å…¶ Owner å°±æ˜¯ awesome-playground, è¿™æ­£æ˜¯æœ¬ç¤ºä¾‹é¡¹ç›®çš„åœ°å€, ç›´æ¥è¾“å…¥ awesome-playground, ç„¶åæŒ‰ä¸‹ tab é”®åˆ‡æ¢ç„¦ç‚¹, Jenkins ä¼šå» GitHub æ‰¾åˆ°è¯¥ Owner ä¸‹çš„ä»“åº“, Repository ä¸‹æ‹‰æ¡†å°±å‡ºç°äº†å¯ä¾›é€‰æ‹©çš„é¡¹ç›®.

{% asset_img add-source.png æ·»åŠ æºä»£ç  %}

é€‰æ‹© jenkins-playground, å…¶ä»–çš„ä¿æŒé»˜è®¤å³å¯, åé¢æœ‰éœ€è¦å†è§£é‡Šå…¶å«ä¹‰.

### æä¾› Jenkinsfile é…ç½®

åˆ‡æ¢åˆ° Build Configuration æ ‡ç­¾é¡µ, å¯ä»¥çœ‹åˆ° Mode æ˜¯ by Jenkinsfile, ä¹Ÿå°±æ˜¯è¯´è¯¥å·¥ä½œé¡¹ç›®çš„è¿ä½œæ¨¡å¼æ˜¯é€šè¿‡ Jenkinsfile æŒ‡å®šçš„;

ä½ å¯ä»¥åœ¨å‰é¢æ–°å»ºå·¥ä½œé¡¹ç›®çš„æ—¶å€™ä¸é€‰æ‹© Multibranch Pipeline, è€Œæ˜¯é€‰æ‹© Freestyle Project, ç„¶ååœ¨ç•Œé¢ä¸Šç‚¹ç‚¹ç‚¹åˆ›å»ºä¸€ä¸ªå·¥ä½œæµ, ä½†æ˜¯ä½¿ç”¨ç•Œé¢çš„ç¼ºç‚¹æ˜¯ä¸å¯é‡å¤, å¦‚æœé¡¹ç›®æœ‰å¤šä¸ªå¼€å‘äººå‘˜/æµ‹è¯•äººå‘˜éœ€è¦åœ¨æœ¬åœ°è¿è¡Œ Jenkins æœåŠ¡å™¨, é‚£ä¹ˆå¯èƒ½å› ä¸ºé…ç½®ä¸ä¸€æ ·å¯¼è‡´è¿è¡Œç»“æœä¸ä¸€è‡´, å› æ­¤æˆ‘ä»¬è¿™é‡Œé€‰æ‹©ä½¿ç”¨ Jenkinsfile æ¥æŒ‡å®šè¿™ä¸ªå·¥ä½œæµçš„è¿è¡Œ;

Jenkinsfile æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶, æ¨èçš„æœ€ä½³å®è·µæ˜¯å°†è¯¥æ–‡ä»¶ä¹Ÿæ·»åŠ åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­, å¥½åœ¨é¡¹ç›®ä»£ç å˜æ›´æ—¶åŒæ—¶æ›´æ–° Jenkinsfile, å¹¶ä¸”è®©æŒç»­é›†æˆ/äº¤ä»˜çš„æ¼”å˜ä¹Ÿèƒ½è¢«è·Ÿè¸ª. æ„æ–™ä¹‹ä¸­çš„æ˜¯åœ¨æˆ‘ä»¬çš„ jenkins-playground é¡¹ç›®ä¸­å·²ç»åŒ…å«äº† Jenkinsfile æ–‡ä»¶äº†, Jenkins é»˜è®¤ä¼šåœ¨ç‰ˆæœ¬æ§åˆ¶é¡¹ç›®çš„æ ¹ç›®å½•è¯»å–æ–‡ä»¶åä¸º Jenkinsfile çš„æ–‡ä»¶æ¥è¿è¡Œè¿™ä¸ªé¡¹ç›®, å¦‚æœä½ çš„é…ç½®æ–‡ä»¶åä¸æ˜¯ Jenkinsfile, é‚£å°±è¦é€šè¿‡ Script Path æŒ‡å®šä½ è‡ªå·±çš„é…ç½®æ–‡ä»¶:

{% asset_img script-path.png é…ç½®è„šæœ¬æ–‡ä»¶è·¯å¾„ %}

> Jenkinsfile çš„é…ç½®è¯´æ˜è§[ğŸ‘‡ Jenkinsfile é…ç½®è¯´æ˜](#Jenkinsfile-é…ç½®è¯´æ˜)

{% asset_img scan-repo.png æ‰«æ Repo %}

Jenkins æ‰«æ GitHub ä¸Šçš„ Repo, æŸ¥æ‰¾ Jenkinsfile, ä¸€åˆ‡ OK ä¹‹å, å°±å¼€å§‹ build äº†, å¯ä»¥åœ¨é¡¹ç›®åˆ—è¡¨ä¸­ç‚¹å‡»è¯¥é¡¹ç›®ä¸­çš„ Last Success æˆ– Last Failure æ—è¾¹çš„ # æ•°å­—, è¿›å…¥é¡¹ç›®æœ€è¿‘ä¸€æ¬¡ Build çš„è¯¦æƒ…, ç„¶ååœ¨å·¦ä¾§é€‰æ‹© Console Output æŸ¥çœ‹æ„å»ºè¾“å‡º:

{% asset_img item-list.png é¡¹ç›®åˆ—è¡¨ %}

{% asset_img console-output.png æ§åˆ¶å°è¾“å‡º %}

### Jenkinsfile é…ç½®è¯´æ˜

æœ¬é¡¹ç›®ä¸­çš„ Jenkinsfile æ–‡ä»¶å†…å®¹å¦‚ä¸‹:

```jenkinsfile
pipeline {
  agent {
    docker {
      image 'maven:3.3.3'
    }
  }
  stages {
    stage('Unit test') {
      steps {
        sh 'mvn test'
      }
    }
    stage('Build') {
      steps {
        sh 'mvn package'
      }
    }
  }
}
```

Jenkinsfile æ–‡ä»¶ä½¿ç”¨[**é¢†åŸŸç‰¹å®šè¯­è¨€(Domain-Specific Language, DSL)**](https://en.wikipedia.org/wiki/Domain-specific_language)æ¥å£°æ˜ Pipeline çš„è¿ä½œ, è¿™ç§æ¨¡å¼ç§°ä¸ºå£°æ˜å¼(Declarative) Pipeline; å¦‚ä¸Šæ‰€ç¤º, DSL çš„è¯­æ³•éå¸¸ç®€å•:

`pipeline`: å£°æ˜äº†ä¸€ä¸ª pipeline, å› ä¸ºæˆ‘ä»¬è¿™ä¸ªé¡¹ç›®éœ€è¦ä½¿ç”¨ maven, æˆ‘ä»¬ä¸æƒ³åœ¨æœ¬åœ°å®‰è£… maven, å› æ­¤å¸Œæœ›è®© [Docker](https://www.docker.com) æ¥è¿è¡Œ maven å‘½ä»¤, å› æ­¤æŒ‡å®šäº†è¯¥ pipeline çš„ä¸€ä¸ª agent (ä»£ç†) ä¸º `docker`, å¹¶æŒ‡å®šäº†éœ€è¦çš„å®¹å™¨é•œåƒæ˜¯ maven, docker tag æ˜¯ 3.3.3;

> å…³äº Docker çš„æ›´å¤šæ–‡æ¡£è¯·æŸ¥çœ‹ [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com)

- `stages`: å¦‚ä¸Šæ‰€è¿°, Jenkins å°†å¯é‡å¤çš„æµæ°´çº¿åˆ†ä¸ºå¤šä¸ª Stage, æ­¤å¤„å°±å£°æ˜äº†è¯¥é¡¹ç›®åŒ…å«çš„é˜¶æ®µ, è¿™é‡Œæœ‰ä¸¤ä¸ªé˜¶æ®µ;

- `stage('Unit test')`: å£°æ˜äº†ç¬¬ä¸€ä¸ªé˜¶æ®µçš„å•å…ƒæµ‹è¯•, Unit test, è¯¥é˜¶æ®µåªæœ‰ä¸€ä¸ªæ­¥éª¤, åªéœ€è¦æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ `mvn test`;

- `stage('Build')`: ç±»ä¼¼ `stage('Unit test')`;
