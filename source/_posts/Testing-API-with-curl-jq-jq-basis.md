---
title: ä½¿ç”¨ `curl` å’Œ `jq` æµ‹è¯• RESTful API - `jq` åŸºç¡€
date: 2018-03-18 10:34:15
tags: [CLI, Productivity]
---

{% include_code "A json file for testing" lang:json Testing-RESTful-API-with-curl-and-jq-jq-basis/test.json %}

## `jq` åŸºç¡€ç”¨æ³•

> åœ¨ [è¿™é‡Œ](https://stedolan.github.io/jq/manual/) æŸ¥çœ‹ `jq` çš„å®Œæ•´æ‰‹å†Œ

### ä½¿ç”¨ `jq` æ ¼å¼åŒ– json 

```shell
$ echo '{"key": "value"}' | jq
```

ä»¥ä¸Šå‘½ä»¤ `echo` å‘½ä»¤æ‰“å°å­—ç¬¦ä¸² `{"key": "value"}` åˆ°æ§åˆ¶å°, ç®¡é“ç¬¦ (pipeline) `|` å°†å‰é¢çš„å‘½ä»¤çš„è¾“å‡ºä½œä¸ºåé¢ `jq` çš„è¾“å…¥, `jq` ä¼šæ ¼å¼åŒ–è¯¥å­—ç¬¦ä¸²;

```shell
$ cat /tmp/test.json | jq
```

ä»¥ä¸Šå‘½ä»¤å°†æ–‡ä»¶ `/tmp/test.json` çš„å†…å®¹æ‰“å°åˆ°æ§åˆ¶å°, ç®¡é“ç¬¦ (pipeline) `|` å°†å‰é¢çš„å‘½ä»¤çš„è¾“å‡ºä½œä¸ºåé¢ `jq` çš„è¾“å…¥, å› æ­¤è¯¥å‘½ä»¤æ˜¯å°†æ–‡ä»¶ `/tmp/test.json` å†…çš„å­—ç¬¦ä¸²ä½œä¸º `jq` å‘½ä»¤çš„è¾“å…¥, æ¥è¿è¡Œ `jq` å‘½ä»¤;

ä½¿ç”¨ `jq` æ ¼å¼åŒ– json æ–‡ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç”¨æ³•:

```shell
$ jq . /tmp/test.json
```

å…¶ä¸­ `.` æ˜¯ `jq` çš„ä¸€ç§è¿‡æ»¤å™¨, è¡¨ç¤ºæŠŠæ ¼å¼åŒ–åçš„ json åŸæ ·æ‰“å°å‡ºæ¥, æ›´å¤šçš„è¿‡æ»¤å™¨å‚è§åæ–‡;

{% include_code "æ ¼å¼åŒ–åçš„ test-formatted.json" lang:json Testing-RESTful-API-with-curl-and-jq-jq-basis/test-formatted.json %}

### ä½¿ç”¨ `jq` è¿‡æ»¤å™¨

å¦‚æœæƒ³å¯¹ json å­—ç¬¦ä¸²è¿›è¡Œæ“ä½œ, å¯ä»¥ä½¿ç”¨ `jq` çš„è¿‡æ»¤å™¨;

#### æå– keys 

åœ¨åšç½‘ç»œçˆ¬è™«å’Œå¯¹æ¥ç¬¬ä¸‰æ–¹ API çš„æ—¶å€™, ç»å¸¸éœ€è¦å¯¹ç¬¬ä¸‰æ–¹çš„ API è¿”å›ç»“æœå»ºç«‹å¯¹åº”çš„ `Java Bean`, å…¶ä¸­æœ€æ— èŠçš„æ“ä½œå°±æ˜¯ä¸€ä¸ªä¸€ä¸ªå¤åˆ¶ç¬¬ä¸‰æ–¹ API è¿”å›çš„ json çš„æ‰€æœ‰ key , ä½œä¸º `Java Bean` çš„å­—æ®µå, ä½¿ç”¨ `jq` çš„ `keys` è¿‡æ»¤å™¨å¯ä»¥ç®€åŒ–è¿™ä¸ªæ— èŠçš„è¿‡ç¨‹:

```shell
$ jq 'keys' /tmp/test.json
[
  "data",
  "errorMsg",
  "status"
]
```

#### æå–ä¸€ä¸ª key å€¼

`jq` é»˜è®¤å°†åŸ json å­—ç¬¦ä¸²æ ¼å¼åŒ–å¹¶åŸæ ·æ‰“å°, å¦‚æœåªå¯¹ json ä¸­çš„ä¸€ä¸ªå­—æ®µçš„å€¼æ„Ÿå…´è¶£, å¯ä»¥åœ¨ `.` ååŠ å­—æ®µå, `jq` å°†åªæ‰“å°è¯¥å­—æ®µçš„å€¼:

```shell
$ jq '.status' /tmp/test.json
200
```

#### æå–å¤šä¸ª key å€¼

å¦‚æœæƒ³æå–å¤šä¸ª key å€¼, å¯ä»¥ä½¿ç”¨é€—å·åˆ†éš”è¦æå–çš„ `key` åç§°:

```shell
$ jq '.status, .errorMsg' /tmp/test.json
```

#### è®¡ç®—é•¿åº¦ length

æœ‰æ—¶å€™ä¸ºäº†éªŒè¯ä¸€ä¸ªæ¥å£è¿”å›çš„æ•°æ®æ•°é‡æ˜¯å¦ä¸é¢„æœŸçš„ä¸€è‡´, å¦‚å¯¹äºåˆ†é¡µæ¥å£è¦éªŒè¯è¿”å›æ¯é¡µæ•°é‡æ˜¯å¦ä¸æœŸæœ›çš„ä¸€è‡´, å¯ä»¥ä½¿ç”¨ `length` è¿‡æ»¤å™¨

- å¦‚æœè¾“å…¥æ˜¯ json å¯¹è±¡, `length` è¿‡æ»¤å™¨å°†è®¡ç®—è¯¥å¯¹è±¡çš„ key æ•°é‡:

```shell
$ jq 'length' /tmp/test.json
3
```

- å¦‚æœè¾“å…¥æ˜¯ json array æ•°ç»„, `length` è¿‡æ»¤å™¨è®¡ç®—è¯¥æ•°ç»„çš„å…ƒç´ ä¸ªæ•°:

```shell
$ jq '.data | length' /tmp/test.json
10
```

`jq` çš„è¿‡æ»¤å™¨åŒæ ·ä½¿ç”¨ç®¡é“ç¬¦ `|` ä¸²è”å¤šä¸ªè¿‡æ»¤å™¨, ä»¥ä¸Šå‘½ä»¤å…ˆæŠ½å–å‡º `data` å­—æ®µçš„å€¼ (æ­¤å¤„æ˜¯ä¸€ä¸ªæ•°ç»„), ç„¶åå°†è¯¥å€¼ä½œä¸ºè¿‡æ»¤å™¨ `length` çš„è¾“å…¥, æ‰€ä»¥ä»¥ä¸Šå‘½ä»¤è®¡ç®—äº† `data` å­—æ®µæ•°ç»„é•¿åº¦;

#### æå–æ•°ç»„æ‰€æœ‰å…ƒç´ çš„ key å€¼

æµ‹è¯• json æ–‡ä»¶ä¸­ `data key` æ‰€å¯¹åº”çš„å€¼æ˜¯ä¸€ä¸ª `video` å¯¹è±¡çš„æ•°ç»„, ä¸ºäº†æå–æ‰€æœ‰ `video` çš„ `title` å­—æ®µ, å¯ä»¥å°† "æå– key å€¼" çš„è¿‡æ»¤å™¨ä¸²è”èµ·æ¥ä½¿ç”¨:

```shell
$ jq '.data[] | .title' /tmp/test.json
```

ä»¥ä¸Šå‘½ä»¤ä¸­, `.data` æå–å‡º json å¯¹è±¡çš„ `data` å­—æ®µ, æ­¤æ—¶ç»“æœæ˜¯ä¸€ä¸ª `json array` æ•°ç»„, ç”±äº `.key` è¿™ç§è¿‡æ»¤å™¨æ˜¯æå– `json object` å¯¹è±¡çš„ `key` å€¼çš„æ“ä½œ, å› æ­¤ä½¿ç”¨äº† `[]` å°†è¯¥æ•°ç»„æ‹†åˆ†ä¸ºä¸€ä¸ªä¸€ä¸ªçš„ `json object` ä½œä¸ºåé¢ `.title` è¿‡æ»¤å™¨çš„è¾“å…¥;

å¯¹äºè¿ç»­çš„ `key` å€¼æŠ½å–, å¯ä»¥ä¸ä½¿ç”¨ç®¡é“ç¬¦, ç›´æ¥ä¸²è”è¿‡æ»¤å™¨, æ‰€ä»¥ä»¥ä¸Šå‘½ä»¤å’Œä»¥ä¸‹å‘½ä»¤ç­‰ä»·:

```shell
$ jq '.data[].title' /tmp/test.json
```

> ä¸ºäº†å¼„æ¸… `[]` çš„ç”¨æ³•, å¯ä»¥åˆ†åˆ«æ‰§è¡Œ `jq .data /tmp/test.json` å’Œ `jq .data[] /tmp/test.json` å¯¹æ¯”è¾“å‡ºç»“æœ

ä»¥ä¸Šçš„å‘½ä»¤è¾“å‡ºäº†æ‰€æœ‰ `video` çš„ `title` å­—æ®µå€¼:

```text
"å¯ä»¥"
"å‚åŠ äº†å–”"
"ğŸ˜‚"
"hi"
"å†·æ¼ "
"é¡µ"
"å“ˆå“ˆ"
"æ¥äº†"
"2"
"å‚åŠ "
```

#### ä½¿ç”¨ `jq` å‡½æ•°

å¯¹äºä»¥ä¸Šçš„ `test.json` æ–‡ä»¶, è¿‡æ»¤å™¨ `.data[].publishTime` æå–å‡ºæ‰€æœ‰è§†é¢‘çš„å‘å¸ƒæ—¶é—´, ä½†è¯¥æ—¶é—´æ˜¯ä¸€ä¸ª `unix` æ—¶é—´æˆ³, ä¸æ–¹ä¾¿äººé˜…è¯», ä½¿ç”¨ `todate` å‡½æ•°å¯ä»¥å°†æ—¶é—´æˆ³è½¬æ¢æˆæ—¶é—´å­—ç¬¦ä¸²:

```shell
$ jq '.data[].publishTime | todate' /tmp/test.json
"50130-09-04T00:33:20Z"
"50171-12-11T00:30:00Z"
"50171-12-13T18:20:00Z"
"50143-09-17T18:30:00Z"
"50172-02-02T16:16:40Z"
"50171-12-23T18:36:40Z"
"50171-12-22T21:46:40Z"
"50171-12-22T05:06:40Z"
"50171-12-20T22:50:00Z"
"50171-12-20T12:16:40Z"
```

çœ‹åˆ°è½¬æ¢åçš„æ—¶é—´å¹´ä»½éå¸¸å¤§, è¿™æ˜¯å› ä¸º `publishTime` å­—æ®µæ˜¯ç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´æˆ³, è€Œ `todate` å‡½æ•°æ˜¯æŠŠå®ƒå½“ä½œç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³æ¥è½¬æ¢çš„, ä¸ºäº†çº æ­£è¯¥é”™è¯¯, å¯ä»¥ä½¿ç”¨ `jq` çš„å››åˆ™è¿ç®—:

```shell
$ jq '.data[].publishTime / 1000 | todate' /tmp/test.json
"2018-02-28T07:48:02Z"
"2018-03-15T09:33:09Z"
"2018-03-15T09:37:06Z"
"2018-03-05T02:04:57Z"
"2018-03-15T10:50:25Z"
"2018-03-15T09:51:31Z"
"2018-03-15T09:50:16Z"
"2018-03-15T09:49:16Z"
"2018-03-15T09:47:27Z"
"2018-03-15T09:46:49Z"
```

ä»¥ä¸Š `/ 1000` å°† `publishTime` é™¤ä»¥ 1000 è½¬æ¢æˆç§’å, å†è¿›è¡Œ `todate` è½¬æ¢;
